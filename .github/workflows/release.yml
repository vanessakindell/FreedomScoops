name: Release Package

on: [push, pull_request]
      
jobs:
  build_and_release:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Get full repository history
      run: |
        git remote add freedomscoops https://github.com/freedomscoops/freedomscoops.git
        git fetch --all
  
    - name: Install Prerequisites
      run: |
        sudo apt update
        sudo apt install python3-pil asciidoc unzip zip ruby dos2unix
        sudo gem install asciidoctor-pdf --pre
   
    - name: Install Deutex
      run: |
        git clone https://github.com/Doom-Utils/deutex.git
        cd deutex
        git checkout v5.2.1
        sudo apt install libpng-dev
        ./bootstrap
        ./configure
        make
        sudo make install

    - name: Build
      run: |
         make dist

    - name: Get current date
      id: date
      run: echo "date=$(date +'%m-%d-%Y')" >> $GITHUB_OUTPUT
      
    - name: Copy ZIP files from wads folder
      run: |
          mkdir -p release
          cp wads/*.zip release
          
    - name: Upload Freedom Scoops
      id: upload-release-assets
      uses: actions/upload-release-asset@v1
      with:
       path: "release/*.zip"
       tag_name: fs-${{ steps.date.outputs.date }}
       name: FS Release ${{ steps.date.outputs.date }}
       prerelease: true
       body_path: changes.txt
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


